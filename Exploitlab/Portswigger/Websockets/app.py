from flask import Flask,request
import websockets
import asyncio
app = Flask(__name__)

id = "0a06007803daf685c21c148300be0012"

async def hello(msg):

    async with websockets.connect(f"wss://{id}.web-security-academy.net/chat") as websocket:
        await websocket.send("READY")
        res =  await websocket.recv()
        try:
            await websocket.send(msg)
            res =  await websocket.recv()
            return res
        except Exception as e:
            return f"Error: {e}"

@app.route('/')
def main():
    try:
        payload = request.args.get('fuzz')
        msg = f"""{{ "message" : "{payload}"}}"""
        loop = asyncio.new_event_loop()
        res  = loop.run_until_complete(hello(msg))
        return f"<h1>{res}</h1>"
    except Exception as e:
        return f"<h1>Error: {e}</h1>"
if __name__ == '__main__':
   app.run(debug=True,host="0.0.0.0",port=5000)