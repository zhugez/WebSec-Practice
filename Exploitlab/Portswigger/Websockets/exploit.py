from flask import Flask,request
import asyncio
import websockets
import subprocess as sb
id = "0a69006804d1ef5ac0a106d200eb009f"
payload = "Hello"
app = Flask(__name__)


# sb.run("clear")

async def hello(msg):
    async with websockets.connect(f"wss://{id}.web-security-academy.net/chat") as websocket:
        await websocket.send("READY")
        res =  await websocket.recv()
        try:
            await websocket.send(msg)
            res =  await websocket.recv()
            return res
        except:
            pass
            # return e
        return "nothing"

@app.route('/')
def home():
    try:
        payload= request.args.get("fuzz")
        print(f"Argument: {payload}")
        msg = f"""{{ "message" : "{payload}"}}"""
        loop = asyncio.new_event_loop()
        res  = loop.run_until_complete(hello(msg))
    except Exception as e :
        return f"Error: {e}"
    return res


if __name__== "__main__":
    app.run(debug=True,host="0.0.0.0")